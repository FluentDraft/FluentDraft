<Window x:Class="FluentDraft.Views.MainWindow"
        xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
        xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
        xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
        xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
        xmlns:local="clr-namespace:FluentDraft.Views"
        xmlns:converters="clr-namespace:FluentDraft.Converters"
        xmlns:viewmodels="clr-namespace:FluentDraft.ViewModels"
        xmlns:tb="clr-namespace:H.NotifyIcon;assembly=H.NotifyIcon.Wpf"
        mc:Ignorable="d" d:DataContext="{d:DesignInstance viewmodels:MainViewModel}"
        Title="FluentDraft" MinHeight="120" Width="480"
        SizeToContent="{Binding IsHistoryVisible, Converter={StaticResource RecordingColorConverter}, ConverterParameter=SizeToContent}"
        ResizeMode="{Binding IsHistoryVisible, Converter={StaticResource RecordingColorConverter}, ConverterParameter=ResizeMode}"
        WindowStyle="None" AllowsTransparency="True" Background="Transparent"
        MouseDown="Window_MouseDown"
        Topmost="{Binding IsAlwaysOnTop}"
        ShowInTaskbar="True"
        Icon="/Icons/app_icon.png"
        WindowStartupLocation="CenterScreen">

    <Window.InputBindings>
        <KeyBinding Key="Escape" Command="{Binding CancelCommand}"/>
    </Window.InputBindings>

    <Window.Resources>
        <BooleanToVisibilityConverter x:Key="BoolToVis"/>

        <Style TargetType="Button" x:Key="IconButtonStyle">
            <Setter Property="Background" Value="Transparent"/>
            <Setter Property="BorderThickness" Value="0"/>
            <Setter Property="Cursor" Value="Hand"/>
            <Setter Property="Template">
                <Setter.Value>
                    <ControlTemplate TargetType="Button">
                        <Border Background="{TemplateBinding Background}" CornerRadius="4">
                            <ContentPresenter HorizontalAlignment="Center" VerticalAlignment="Center"/>
                        </Border>
                        <ControlTemplate.Triggers>
                            <Trigger Property="IsMouseOver" Value="True">
                                <Setter Property="Background" Value="#33FFFFFF"/>
                            </Trigger>
                        </ControlTemplate.Triggers>
                    </ControlTemplate>
                </Setter.Value>
            </Setter>
        </Style>

        <Style TargetType="CheckBox" x:Key="DarkCheckBoxStyle">
            <Setter Property="Cursor" Value="Hand"/>
            <Setter Property="Template">
                <Setter.Value>
                    <ControlTemplate TargetType="CheckBox">
                        <Grid>
                            <Border x:Name="border" Width="14" Height="14" CornerRadius="3" BorderBrush="#666" BorderThickness="1" Background="Transparent">
                                <Path x:Name="checkMark" Data="M3,7 L6,10 L10,3" Stroke="#007AFF" StrokeThickness="2" Visibility="Collapsed" Margin="1"/>
                            </Border>
                            <ContentPresenter Margin="20,0,0,0" VerticalAlignment="Center"/>
                        </Grid>
                        <ControlTemplate.Triggers>
                            <Trigger Property="IsChecked" Value="True">
                                <Setter TargetName="checkMark" Property="Visibility" Value="Visible"/>
                                <Setter TargetName="border" Property="BorderBrush" Value="#007AFF"/>
                            </Trigger>
                            <Trigger Property="IsMouseOver" Value="True">
                                <Setter TargetName="border" Property="BorderBrush" Value="#888"/>
                            </Trigger>
                        </ControlTemplate.Triggers>
                    </ControlTemplate>
                </Setter.Value>
            </Setter>
        </Style>
        
        <!-- Dark ComboBox Style -->
        <Style x:Key="DarkComboBoxStyle" TargetType="ComboBox">
            <Setter Property="Background" Value="#252525"/>
            <Setter Property="Foreground" Value="White"/>
            <Setter Property="BorderBrush" Value="#444"/>
            <Setter Property="BorderThickness" Value="1"/>
            <Setter Property="Padding" Value="8,4"/>
            <Setter Property="Template">
                <Setter.Value>
                    <ControlTemplate TargetType="ComboBox">
                        <Grid>
                            <ToggleButton x:Name="ToggleButton" 
                                          Background="{TemplateBinding Background}"
                                          BorderBrush="{TemplateBinding BorderBrush}"
                                          BorderThickness="{TemplateBinding BorderThickness}"
                                          IsChecked="{Binding IsDropDownOpen, Mode=TwoWay, RelativeSource={RelativeSource TemplatedParent}}"
                                          ClickMode="Press">
                                <ToggleButton.Template>
                                    <ControlTemplate TargetType="ToggleButton">
                                        <Border Background="{TemplateBinding Background}" BorderBrush="{TemplateBinding BorderBrush}" BorderThickness="{TemplateBinding BorderThickness}" CornerRadius="4">
                                            <Grid>
                                                <Grid.ColumnDefinitions>
                                                    <ColumnDefinition Width="*"/>
                                                    <ColumnDefinition Width="20"/>
                                                </Grid.ColumnDefinitions>
                                                <Path Grid.Column="1" Data="M 0 0 L 4 4 L 8 0 Z" Fill="#888" HorizontalAlignment="Center" VerticalAlignment="Center"/>
                                            </Grid>
                                        </Border>
                                    </ControlTemplate>
                                </ToggleButton.Template>
                            </ToggleButton>
                            <ContentPresenter x:Name="ContentSite" IsHitTestVisible="False" 
                                              Content="{TemplateBinding SelectionBoxItem}"
                                              Margin="8,4,24,4" VerticalAlignment="Center" HorizontalAlignment="Left"/>
                            <TextBox x:Name="PART_EditableTextBox" 
                                     Visibility="Hidden" IsReadOnly="{TemplateBinding IsReadOnly}"
                                     Background="Transparent" Foreground="White" BorderThickness="0"
                                     Margin="4,0,24,0" VerticalAlignment="Center"
                                     CaretBrush="White"/>
                            <Popup x:Name="Popup" Placement="Bottom" IsOpen="{TemplateBinding IsDropDownOpen}" AllowsTransparency="True" Focusable="False" PopupAnimation="Slide">
                                <Border x:Name="DropDownBorder" Background="#252525" BorderBrush="#444" BorderThickness="1" CornerRadius="4" MaxHeight="200">
                                    <ScrollViewer VerticalScrollBarVisibility="Auto">
                                        <StackPanel IsItemsHost="True"/>
                                    </ScrollViewer>
                                </Border>
                            </Popup>
                        </Grid>
                        <ControlTemplate.Triggers>
                            <Trigger Property="IsEditable" Value="True">
                                <Setter TargetName="PART_EditableTextBox" Property="Visibility" Value="Visible"/>
                                <Setter TargetName="ContentSite" Property="Visibility" Value="Hidden"/>
                            </Trigger>
                        </ControlTemplate.Triggers>
                    </ControlTemplate>
                </Setter.Value>
            </Setter>
        </Style>
        
        <!-- Dark ComboBoxItem Style -->
        <Style TargetType="ComboBoxItem">
            <Setter Property="Background" Value="Transparent"/>
            <Setter Property="Foreground" Value="White"/>
            <Setter Property="Padding" Value="8,6"/>
            <Setter Property="Template">
                <Setter.Value>
                    <ControlTemplate TargetType="ComboBoxItem">
                        <Border x:Name="Bd" Background="{TemplateBinding Background}" Padding="{TemplateBinding Padding}">
                            <ContentPresenter/>
                        </Border>
                        <ControlTemplate.Triggers>
                            <Trigger Property="IsMouseOver" Value="True">
                                <Setter TargetName="Bd" Property="Background" Value="#007AFF"/>
                            </Trigger>
                            <Trigger Property="IsSelected" Value="True">
                                <Setter TargetName="Bd" Property="Background" Value="#0056B3"/>
                            </Trigger>
                        </ControlTemplate.Triggers>
                    </ControlTemplate>
                </Setter.Value>
            </Setter>
        </Style>

        <!-- Modern ToolTip Style -->
        <Style TargetType="ToolTip">
            <Setter Property="OverridesDefaultStyle" Value="True"/>
            <Setter Property="HasDropShadow" Value="True"/>
            <Setter Property="Template">
                <Setter.Value>
                    <ControlTemplate TargetType="ToolTip">
                        <Border Background="#252525" 
                                BorderBrush="#444" 
                                BorderThickness="1" 
                                CornerRadius="6" 
                                Padding="10,6">
                            <Border.Effect>
                                <DropShadowEffect BlurRadius="10" ShadowDepth="2" Opacity="0.4"/>
                            </Border.Effect>
                            <ContentPresenter TextElement.Foreground="White" TextElement.FontSize="12"/>
                        </Border>
                    </ControlTemplate>
                </Setter.Value>
            </Setter>
        </Style>

    </Window.Resources>

    <Grid>
        <tb:TaskbarIcon
            x:Name="TrayIcon"
            IconSource="/Icons/app_icon.ico"
            ToolTipText="Whisper"
            TrayMouseDoubleClick="TaskbarIcon_TrayMouseDoubleClick">
            <tb:TaskbarIcon.ContextMenu>
                <ContextMenu>
                    <MenuItem Header="Show" Click="ShowMenuItem_Click"/>
                    <MenuItem Header="Exit" Click="ExitMenuItem_Click"/>
                </ContextMenu>
            </tb:TaskbarIcon.ContextMenu>
        </tb:TaskbarIcon>

        <!-- Main Container -->
        <Border CornerRadius="12" Background="#121212" BorderBrush="#333333" BorderThickness="1">
            <Border.Effect>
                <DropShadowEffect BlurRadius="20" ShadowDepth="5" Opacity="0.5" Color="Black"/>
            </Border.Effect>
            
            <Grid>
                <Grid.RowDefinitions>
                    <RowDefinition Height="130"/>  <!-- Main Content (Waveform + Text) - Fixed Height -->
                    <RowDefinition Height="35"/> <!-- Footer -->
                    <RowDefinition Height="Auto"/> <!-- History -->
                </Grid.RowDefinitions>

                <!-- Top Row: Main Content Overlay -->
                <Grid Grid.Row="0" Margin="20,10" MinHeight="65">
                    
                    <!-- 1. Text Result (Visible if text exists) -->
                    <ScrollViewer VerticalScrollBarVisibility="Auto" BorderThickness="0" Cursor="Hand"
                                  Visibility="{Binding LastTranscription, Converter={StaticResource RecordingColorConverter}, ConverterParameter=HasTextVis}">
                         <ScrollViewer.InputBindings>
                             <MouseBinding MouseAction="LeftClick" Command="{Binding ProcessTextActionCommand}"/>
                         </ScrollViewer.InputBindings>
                         <TextBlock Text="{Binding LastTranscription}" 
                                   TextWrapping="Wrap" Foreground="White" FontSize="14" 
                                   HorizontalAlignment="Center" VerticalAlignment="Center"
                                   TextAlignment="Center"/>
                    </ScrollViewer>

                    <!-- 2. Idle State (Visible if None state AND No Text) -->
                    <Grid Visibility="{Binding UiState, Converter={StaticResource RecordingColorConverter}, ConverterParameter=NoneVis}">
                        <StackPanel VerticalAlignment="Center" HorizontalAlignment="Center"
                                    Visibility="{Binding LastTranscription, Converter={StaticResource RecordingColorConverter}, ConverterParameter=NoTextVis}">
                            <TextBlock Text="Place cursor in any text field" Foreground="#666" FontSize="11" HorizontalAlignment="Center" Margin="0,0,0,4"/>
                            <TextBlock Text="{Binding InstructionText}" Foreground="#AAA" FontSize="13" FontWeight="SemiBold" HorizontalAlignment="Center"/>
                        </StackPanel>
                    </Grid>

                    <!-- 3. Waveform Animation (Visible if Listening) -->
                    <ItemsControl ItemsSource="{Binding AudioWaves}"
                                  Visibility="{Binding UiState, Converter={StaticResource RecordingColorConverter}, ConverterParameter=ListeningVis}"
                                  HorizontalAlignment="Center" VerticalAlignment="Center">
                        <ItemsControl.ItemsPanel>
                            <ItemsPanelTemplate>
                                <StackPanel Orientation="Horizontal"/>
                            </ItemsPanelTemplate>
                        </ItemsControl.ItemsPanel>
                        <ItemsControl.ItemTemplate>
                            <DataTemplate>
                                <Rectangle Width="3" Height="{Binding Height}" RadiusX="1.5" RadiusY="1.5" Fill="#E0E0E0" Margin="1.5,0" VerticalAlignment="Center"/>
                            </DataTemplate>
                        </ItemsControl.ItemTemplate>
                    </ItemsControl>

                    <!-- 4. Processing State (Visible if Transcribing) -->
                    <StackPanel Orientation="Horizontal" HorizontalAlignment="Center" VerticalAlignment="Center"
                                Visibility="{Binding UiState, Converter={StaticResource RecordingColorConverter}, ConverterParameter=TranscribingVis}">
                        <TextBlock Text="Processing..." Foreground="#2193b0" FontSize="14" FontWeight="SemiBold"/>
                    </StackPanel>

                    <!-- 5. Copied Notification Overlay -->
                    <Border Background="#CC000000" CornerRadius="8" Padding="15,8" HorizontalAlignment="Center" VerticalAlignment="Center"
                            Visibility="{Binding IsCopiedNotificationVisible, Converter={StaticResource BoolToVis}}" IsHitTestVisible="False">
                        <StackPanel Orientation="Horizontal">
                            <TextBlock Text="✓" Foreground="#4CD964" FontSize="14" Margin="0,0,8,0" VerticalAlignment="Center"/>
                            <TextBlock Text="Copied!" Foreground="White" FontSize="14" FontWeight="SemiBold" VerticalAlignment="Center"/>
                        </StackPanel>
                    </Border>

                    <!-- 6. Update Notification Overlay -->
                    <Border Background="#1E1E1E" CornerRadius="8" BorderBrush="#333" BorderThickness="1"
                            HorizontalAlignment="Stretch" VerticalAlignment="Top" Margin="4" Padding="10,8"
                            Visibility="{Binding IsUpdateNotificationVisible, Converter={StaticResource BoolToVis}}">
                        <Border.Effect>
                            <DropShadowEffect BlurRadius="10" ShadowDepth="2" Opacity="0.4"/>
                        </Border.Effect>
                        <Grid>
                            <Grid.ColumnDefinitions>
                                <ColumnDefinition Width="*"/>
                                <ColumnDefinition Width="Auto"/>
                            </Grid.ColumnDefinitions>
                            
                            <StackPanel VerticalAlignment="Center" Margin="0,0,10,0">
                                <TextBlock Text="{Binding UpdateNotificationTitle}" Foreground="White" FontSize="12" FontWeight="SemiBold" TextTrimming="CharacterEllipsis"/>
                                <StatusBarItem Padding="0" Margin="0,4,0,0" Visibility="{Binding IsUpdateDownloading, Converter={StaticResource BoolToVis}}">
                                    <ProgressBar Value="{Binding UpdateProgress}" Maximum="100" Height="4" BorderThickness="0" Background="#333" Foreground="#007AFF" Width="150" HorizontalAlignment="Left"/>
                                </StatusBarItem>
                            </StackPanel>

                            <StackPanel Grid.Column="1" Orientation="Horizontal">
                                <Button Command="{Binding UpdateNowCommand}" Content="{Binding UpdateNotificationButtonText}"
                                        Style="{StaticResource IconButtonStyle}" Foreground="#007AFF" FontWeight="SemiBold" FontSize="12" Margin="0,0,8,0" Padding="8,4"/>
                                <Button Command="{Binding DismissUpdateCommand}" Content="Later"
                                        Style="{StaticResource IconButtonStyle}" Foreground="#AAA" FontSize="12" Padding="8,4"/>
                            </StackPanel>
                        </Grid>
                    </Border>
                </Grid>

                <!-- Footer: Controls -->
                <Border Grid.Row="1" Background="#1E1E1E" CornerRadius="0,0,12,12" BorderBrush="#333" BorderThickness="0,1,0,0">
                    <Grid Margin="15,0">
                        <StackPanel Orientation="Horizontal" HorizontalAlignment="Left" VerticalAlignment="Center">
                            <Ellipse Width="8" Height="8" Fill="{Binding IsPostProcessingEnabled, Converter={StaticResource RecordingColorConverter}, ConverterParameter=StateColor}" Margin="0,0,8,0"/>
                            <ToggleButton IsChecked="{Binding IsPostProcessingEnabled}" 
                                          Content="AI Refine" 
                                          FontSize="12" 
                                          Foreground="{Binding IsPostProcessingEnabled, Converter={StaticResource RecordingColorConverter}, ConverterParameter=StateBrush}"
                                          BorderThickness="0" Background="Transparent"
                                          Cursor="Hand">
                                <ToggleButton.Style>
                                    <Style TargetType="ToggleButton">
                                        <Setter Property="Template">
                                            <Setter.Value>
                                                <ControlTemplate TargetType="ToggleButton">
                                                    <TextBlock Text="{TemplateBinding Content}" Foreground="{TemplateBinding Foreground}"/>
                                                </ControlTemplate>
                                            </Setter.Value>
                                        </Setter>
                                        <Style.Triggers>
                                            <Trigger Property="IsChecked" Value="True">
                                                <Setter Property="Foreground" Value="#007AFF"/>
                                            </Trigger>
                                            <Trigger Property="IsChecked" Value="False">
                                                <Setter Property="Foreground" Value="#666"/>
                                            </Trigger>
                                        </Style.Triggers>
                                    </Style>
                                </ToggleButton.Style>
                            </ToggleButton>
                            
                            <!-- Preset Selector -->
                            <ComboBox ItemsSource="{Binding RefinementPresets}"
                                      SelectedItem="{Binding SelectedRefinementPreset}"
                                      DisplayMemberPath="Name"
                                      Style="{StaticResource DarkComboBoxStyle}"
                                      Visibility="{Binding IsPostProcessingEnabled, Converter={StaticResource BoolToVis}}"
                                      Margin="10,0,0,0"
                                      MinWidth="100"
                                      FontSize="11"/>

                            <!-- Reset Session Button -->
                            <Button Command="{Binding ResetChatSessionCommand}" 
                                    Style="{StaticResource IconButtonStyle}" 
                                    Margin="8,0,0,0"
                                    Visibility="{Binding IsPostProcessingEnabled, Converter={StaticResource BoolToVis}}"
                                    ToolTipService.InitialShowDelay="0"
                                    ToolTipService.ShowDuration="5000">
                                <Button.ToolTip>
                                    <ToolTip>
                                        <StackPanel Orientation="Vertical">
                                            <TextBlock Text="Reset Session Context" FontWeight="SemiBold"/>
                                            <TextBlock Text="Start fresh topic (Click to reset)" FontSize="10" Foreground="#AAA" Margin="0,2,0,0"/>
                                        </StackPanel>
                                    </ToolTip>
                                </Button.ToolTip>
                                <Path Data="M17.65 6.35C16.2 4.9 14.21 4 12 4c-4.42 0-7.99 3.58-7.99 8s3.57 8 7.99 8c3.73 0 6.84-2.55 7.73-6h-2.08c-.82 2.33-3.04 4-5.65 4-3.31 0-6-2.69-6-6s2.69-6 6-6c1.66 0 3.14.69 4.22 1.78L13 11h7V4l-2.35 2.35z"
                                      Fill="#666" 
                                      Width="12" Height="12" 
                                      Stretch="Uniform"
                                      VerticalAlignment="Center" Margin="2,0"/>
                            </Button>

                            <!-- Auto-Paste Toggle -->
                             <Ellipse Width="6" Height="6" Fill="{Binding IsAutoInsertEnabled, Converter={StaticResource RecordingColorConverter}, ConverterParameter=StateColor}" Margin="15,0,6,0"/>
                             <ToggleButton IsChecked="{Binding IsAutoInsertEnabled}" 
                                           Content="Auto-Paste" 
                                           FontSize="12" 
                                           Foreground="{Binding IsAutoInsertEnabled, Converter={StaticResource RecordingColorConverter}, ConverterParameter=StateBrush}"
                                           BorderThickness="0" Background="Transparent"
                                           Cursor="Hand">
                                 <ToggleButton.Template>
                                     <ControlTemplate TargetType="ToggleButton">
                                         <TextBlock Text="{TemplateBinding Content}" Foreground="{TemplateBinding Foreground}"/>
                                     </ControlTemplate>
                                 </ToggleButton.Template>
                             </ToggleButton>
                        </StackPanel>

                        <StackPanel Orientation="Horizontal" HorizontalAlignment="Right" VerticalAlignment="Center">
                             <!-- Copy Button (visible if text) -->
                             <Button Command="{Binding CopyLastTranscriptionCommand}" Style="{StaticResource IconButtonStyle}" Margin="0,0,10,0"
                                     ToolTip="Copy Text"
                                     Visibility="{Binding LastTranscription, Converter={StaticResource RecordingColorConverter}, ConverterParameter=HasTextVis}">
                                 <StackPanel Orientation="Horizontal">
                                     <TextBlock Text="Copy" Foreground="#AAA" FontSize="11" VerticalAlignment="Center" Margin="0,0,5,0"/>
                                     <TextBlock Text="↵" Foreground="#666" FontSize="10" VerticalAlignment="Center"/>
                                 </StackPanel>
                             </Button>

                             <!-- History Button -->
                             <Button Command="{Binding ToggleHistoryCommand}" Style="{StaticResource IconButtonStyle}" Margin="0,0,10,0" ToolTip="{DynamicResource S_Main_History}">
                                 <TextBlock Text="{DynamicResource S_Main_Recent}" Foreground="{Binding IsHistoryVisible, Converter={StaticResource RecordingColorConverter}, ConverterParameter=StateBrush}" FontSize="11" VerticalAlignment="Center"/>
                             </Button>

                            <!-- Settings Button -->
                            <Button Command="{Binding ToggleSettingsCommand}" Style="{StaticResource IconButtonStyle}" Margin="0,0,10,0" ToolTip="Settings">
                                <TextBlock Text="⚙" Foreground="#AAA" FontSize="12"/>
                            </Button>

                            <!-- Stop/Cancel Hints -->
                            <StackPanel Orientation="Horizontal" Visibility="{Binding UiState, Converter={StaticResource RecordingColorConverter}, ConverterParameter=ListeningVis}">
                                <Button Command="{Binding CancelCommand}" Style="{StaticResource IconButtonStyle}">
                                    <StackPanel Orientation="Horizontal">
                                        <TextBlock Text="{DynamicResource S_Btn_Stop}" Foreground="#AAA" FontSize="12" Margin="0,0,5,0"/>
                                        <Border CornerRadius="3" Background="#333" Padding="4,1">
                                           <TextBlock Text="Esc" Foreground="#888" FontSize="10"/>
                                        </Border>
                                    </StackPanel>
                                </Button>
                            </StackPanel>
                            
                             <!-- Close App -->
                            <Button Click="CloseButton_Click" Style="{StaticResource IconButtonStyle}" Margin="10,0,0,0" ToolTip="Close">
                                <TextBlock Text="✕" Foreground="#AAA" FontSize="10"/>
                            </Button>
                        </StackPanel>
                    </Grid>
                </Border>
                

                <!-- History Panel (Row 2) -->
                <Border Grid.Row="2" Background="#181818" BorderBrush="#333" BorderThickness="0,1,0,0" Padding="0,10"
                        Visibility="{Binding IsHistoryVisible, Converter={StaticResource BoolToVis}}" MaxHeight="300">
                    <Grid>
                        <Grid.RowDefinitions>
                            <RowDefinition Height="Auto"/>
                            <RowDefinition Height="*"/>
                        </Grid.RowDefinitions>

                        <!-- Header -->
                        <Grid Margin="15,0,15,5">
                            <StackPanel Orientation="Horizontal">
                                <TextBlock Text="{DynamicResource S_Main_History}" Foreground="#AAA" FontWeight="Bold" VerticalAlignment="Center" Margin="0,0,15,0"/>
                                
                                <!-- Selection Toolbar -->
                                <Button Command="{Binding SelectAllHistoryCommand}" Content="{DynamicResource S_Main_SelectAll}" ToolTip="{DynamicResource S_Main_SelectAll}"
                                        Foreground="#007AFF" Background="Transparent" BorderThickness="0" Cursor="Hand" FontSize="11" Margin="0,0,10,0"/>
                                <Button Command="{Binding DeselectAllHistoryCommand}" Content="{DynamicResource S_Main_ClearSel}" ToolTip="{DynamicResource S_Main_ClearSel}"
                                        Foreground="#666" Background="Transparent" BorderThickness="0" Cursor="Hand" FontSize="11" Margin="0,0,10,0"/>
                                <Button Command="{Binding CopySelectedHistoryCommand}" Content="{DynamicResource S_Main_CopySel}" ToolTip="{DynamicResource S_Main_CopySel}"
                                        Visibility="{Binding HasSelectedItems, Converter={StaticResource BoolToVis}}"
                                        Foreground="#4CD964" Background="Transparent" BorderThickness="0" Cursor="Hand" FontSize="11"/>
                            </StackPanel>

                            <Button Command="{Binding ClearHistoryCommand}" Content="{DynamicResource S_Main_ClearHist}" HorizontalAlignment="Right"
                                    Foreground="#FF453A" Background="Transparent" BorderThickness="0" Cursor="Hand" FontSize="11"/>
                        </Grid>

                        <!-- List -->
                        <ListView Grid.Row="1" ItemsSource="{Binding HistoryItems}" Background="Transparent" BorderThickness="0"
                                  ScrollViewer.HorizontalScrollBarVisibility="Disabled">
                            <ListView.ItemContainerStyle>
                                <Style TargetType="ListViewItem">
                                    <Setter Property="HorizontalContentAlignment" Value="Stretch"/>
                                    <Setter Property="Background" Value="Transparent"/>
                                    <Setter Property="Template">
                                        <Setter.Value>
                                            <ControlTemplate TargetType="ListViewItem">
                                                <Border Background="{TemplateBinding Background}" CornerRadius="6" Margin="10,2" Padding="8">
                                                    <ContentPresenter/>
                                                </Border>
                                                <ControlTemplate.Triggers>
                                                    <Trigger Property="IsMouseOver" Value="True">
                                                        <Setter Property="Background" Value="#252525"/>
                                                    </Trigger>
                                                </ControlTemplate.Triggers>
                                            </ControlTemplate>
                                        </Setter.Value>
                                    </Setter>
                                </Style>
                            </ListView.ItemContainerStyle>
                            <ListView.ItemTemplate>
                                <DataTemplate>
                                    <Grid>
                                        <Grid.RowDefinitions>
                                            <RowDefinition Height="Auto"/>
                                            <RowDefinition Height="Auto"/>
                                        </Grid.RowDefinitions>
                                        
                                        <!-- Top: Time and Actions -->
                                        <Grid Grid.Row="0" Margin="0,0,0,4">
                                            <StackPanel Orientation="Horizontal" VerticalAlignment="Center">
                                                <CheckBox IsChecked="{Binding IsSelected}" VerticalAlignment="Center" Margin="0,0,8,0" Style="{StaticResource DarkCheckBoxStyle}"/>
                                                <TextBlock Text="{Binding Timestamp, StringFormat=t}" Foreground="#666" FontSize="11" VerticalAlignment="Center"/>
                                            </StackPanel>
                                            
                                            <StackPanel Orientation="Horizontal" HorizontalAlignment="Right">
                                                <Button Command="{Binding DataContext.PlayHistoryItemCommand, RelativeSource={RelativeSource AncestorType=Window}}" 
                                                        CommandParameter="{Binding}" Content="▶" ToolTip="Play Audio"
                                                        Foreground="#007AFF" Background="Transparent" BorderThickness="0" Cursor="Hand" Margin="0,0,8,0" FontSize="10"/>
                                                
                                                <Button Command="{Binding DataContext.CopyHistoryItemCommand, RelativeSource={RelativeSource AncestorType=Window}}" 
                                                        CommandParameter="{Binding}" Content="Copy" ToolTip="Copy Text"
                                                        Foreground="#AAA" Background="Transparent" BorderThickness="0" Cursor="Hand" Margin="0,0,8,0" FontSize="10"/>
                                                
                                                <Button Command="{Binding DataContext.DeleteHistoryItemCommand, RelativeSource={RelativeSource AncestorType=Window}}" 
                                                        CommandParameter="{Binding}" Content="✕" ToolTip="Delete"
                                                        Foreground="#FF453A" Background="Transparent" BorderThickness="0" Cursor="Hand" FontSize="10"/>
                                            </StackPanel>
                                        </Grid>

                                        <!-- Bottom: Text -->
                                        <TextBlock Grid.Row="1" Text="{Binding Text}" Foreground="White" TextWrapping="Wrap" FontSize="12"/>
                                    </Grid>
                                </DataTemplate>
                            </ListView.ItemTemplate>
                        </ListView>
                    </Grid>
                </Border>
            </Grid>
        </Border>
    </Grid>
</Window>
