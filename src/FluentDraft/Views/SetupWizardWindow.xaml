<Window x:Class="FluentDraft.Views.SetupWizardWindow"
        xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
        xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
        xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
        xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
        xmlns:vm="clr-namespace:FluentDraft.ViewModels"
        xmlns:converters="clr-namespace:FluentDraft.Converters"
        mc:Ignorable="d" 
        Title="Welcome to FluentDraft" Height="650" Width="850"
        WindowStartupLocation="CenterScreen" ResizeMode="CanResize" WindowStyle="SingleBorderWindow"
        Background="#181818"
        PreviewKeyDown="Window_PreviewKeyDown">

    <Window.Resources>
         <converters:IntToBoolConverter x:Key="IntToBoolConverter"/>
         <converters:IntToVisibilityConverter x:Key="IntToVisibilityConverter"/>
         <BooleanToVisibilityConverter x:Key="BoolToVis"/>
         
         <Style TargetType="TextBox">
            <Setter Property="Background" Value="#252525"/>
            <Setter Property="Foreground" Value="White"/>
            <Setter Property="BorderThickness" Value="0"/>
            <Setter Property="Padding" Value="8"/>
            <Setter Property="CaretBrush" Value="White"/>
            <Setter Property="Template">
                <Setter.Value>
                    <ControlTemplate TargetType="TextBox">
                        <Border Background="{TemplateBinding Background}" BorderBrush="{TemplateBinding BorderBrush}" BorderThickness="{TemplateBinding BorderThickness}" CornerRadius="4" Padding="{TemplateBinding Padding}">
                            <ScrollViewer x:Name="PART_ContentHost"/>
                        </Border>
                    </ControlTemplate>
                </Setter.Value>
            </Setter>
        </Style>

        <Style TargetType="Button">
            <Setter Property="Background" Value="#333"/>
            <Setter Property="Foreground" Value="White"/>
            <Setter Property="BorderThickness" Value="0"/>
            <Setter Property="Padding" Value="15,8"/>
            <Setter Property="Cursor" Value="Hand"/>
            <Setter Property="Template">
                <Setter.Value>
                     <ControlTemplate TargetType="Button">
                        <Border Background="{TemplateBinding Background}" CornerRadius="4" Padding="{TemplateBinding Padding}">
                            <ContentPresenter HorizontalAlignment="Center" VerticalAlignment="Center"/>
                        </Border>
                         <ControlTemplate.Triggers>
                            <Trigger Property="IsMouseOver" Value="True">
                                <Setter Property="Background" Value="#444"/>
                            </Trigger>
                             <Trigger Property="IsEnabled" Value="False">
                                <Setter Property="Opacity" Value="0.5"/>
                            </Trigger>
                        </ControlTemplate.Triggers>
                    </ControlTemplate>
                </Setter.Value>
            </Setter>
        </Style>

         <!-- Dark ComboBox Style -->
        <Style TargetType="ComboBox">
            <Setter Property="Background" Value="#252525"/>
            <Setter Property="Foreground" Value="White"/>
            <Setter Property="BorderBrush" Value="#444"/>
            <Setter Property="BorderThickness" Value="1"/>
            <Setter Property="Padding" Value="8,4"/>
            <Setter Property="Template">
                <Setter.Value>
                    <ControlTemplate TargetType="ComboBox">
                        <Grid>
                            <ToggleButton x:Name="ToggleButton" 
                                          Background="{TemplateBinding Background}"
                                          BorderBrush="{TemplateBinding BorderBrush}"
                                          BorderThickness="{TemplateBinding BorderThickness}"
                                          IsChecked="{Binding IsDropDownOpen, Mode=TwoWay, RelativeSource={RelativeSource TemplatedParent}}"
                                          ClickMode="Press">
                                <ToggleButton.Template>
                                    <ControlTemplate TargetType="ToggleButton">
                                        <Border Background="{TemplateBinding Background}" BorderBrush="{TemplateBinding BorderBrush}" BorderThickness="{TemplateBinding BorderThickness}" CornerRadius="4">
                                            <Grid>
                                                <Grid.ColumnDefinitions>
                                                    <ColumnDefinition Width="*"/>
                                                    <ColumnDefinition Width="20"/>
                                                </Grid.ColumnDefinitions>
                                                <Path Grid.Column="1" Data="M 0 0 L 4 4 L 8 0 Z" Fill="#888" HorizontalAlignment="Center" VerticalAlignment="Center"/>
                                            </Grid>
                                        </Border>
                                    </ControlTemplate>
                                </ToggleButton.Template>
                            </ToggleButton>
                            <ContentPresenter x:Name="ContentSite" IsHitTestVisible="False" 
                                              Content="{TemplateBinding SelectionBoxItem}"
                                              Margin="8,4,24,4" VerticalAlignment="Center" HorizontalAlignment="Left"/>
                            <TextBox x:Name="PART_EditableTextBox" 
                                     Visibility="Hidden" IsReadOnly="{TemplateBinding IsReadOnly}"
                                     Background="Transparent" Foreground="White" BorderThickness="0"
                                     Margin="4,0,24,0" VerticalAlignment="Center"
                                     CaretBrush="White"/>
                            <Popup x:Name="Popup" Placement="Bottom" IsOpen="{TemplateBinding IsDropDownOpen}" AllowsTransparency="True" Focusable="False" PopupAnimation="Slide">
                                <Border x:Name="DropDownBorder" Background="#252525" BorderBrush="#444" BorderThickness="1" CornerRadius="4" MaxHeight="250">
                                    <ScrollViewer VerticalScrollBarVisibility="Auto">
                                        <StackPanel IsItemsHost="True"/>
                                    </ScrollViewer>
                                </Border>
                            </Popup>
                        </Grid>
                        <ControlTemplate.Triggers>
                            <Trigger Property="IsEditable" Value="True">
                                <Setter TargetName="PART_EditableTextBox" Property="Visibility" Value="Visible"/>
                                <Setter TargetName="ContentSite" Property="Visibility" Value="Hidden"/>
                            </Trigger>
                        </ControlTemplate.Triggers>
                    </ControlTemplate>
                </Setter.Value>
            </Setter>
        </Style>
        
        <!-- Dark ComboBoxItem Style -->
        <Style TargetType="ComboBoxItem">
            <Setter Property="Background" Value="Transparent"/>
            <Setter Property="Foreground" Value="White"/>
            <Setter Property="Padding" Value="8,6"/>
            <Setter Property="Template">
                <Setter.Value>
                    <ControlTemplate TargetType="ComboBoxItem">
                        <Border x:Name="Bd" Background="{TemplateBinding Background}" Padding="{TemplateBinding Padding}">
                            <ContentPresenter/>
                        </Border>
                        <ControlTemplate.Triggers>
                            <Trigger Property="IsMouseOver" Value="True">
                                <Setter TargetName="Bd" Property="Background" Value="#007AFF"/>
                            </Trigger>
                            <Trigger Property="IsSelected" Value="True">
                                <Setter TargetName="Bd" Property="Background" Value="#0056B3"/>
                            </Trigger>
                        </ControlTemplate.Triggers>
                    </ControlTemplate>
                </Setter.Value>
            </Setter>
        </Style>
    </Window.Resources>

    <Grid>
        <Grid.RowDefinitions>
            <RowDefinition Height="Auto"/>
            <RowDefinition Height="*"/>
            <RowDefinition Height="80"/>
        </Grid.RowDefinitions>

        <!-- Header -->
        <Border Background="#202020" Padding="30,20">
            <TextBlock Text="Welcome to FluentDraft" FontSize="24" FontWeight="Bold" Foreground="White" HorizontalAlignment="Center"/>
        </Border>

        <!-- Content -->
        <Border Grid.Row="1" Padding="40">
            <ScrollViewer VerticalScrollBarVisibility="Auto" HorizontalScrollBarVisibility="Disabled" Padding="0,0,10,0">
                <Grid>
                     <Grid.RowDefinitions>
                         <RowDefinition Height="Auto"/> <!-- 0: Header -->
                         <RowDefinition Height="*"/>    <!-- 1: Body -->
                         <RowDefinition Height="Auto"/> <!-- 2: Footer -->
                     </Grid.RowDefinitions>
                <!-- Step 1: Provider -->
                <StackPanel Grid.Row="1" Visibility="{Binding CurrentStep, Converter={StaticResource IntToVisibilityConverter}, ConverterParameter=1}">
                    <TextBlock Text="1. Connect AI Provider" FontSize="20" FontWeight="SemiBold" Foreground="#007AFF" Margin="0,0,0,20"/>
                    
                    <TextBlock Text="Select Provider" Foreground="#888" Margin="0,0,0,5"/>
                    <ComboBox SelectedValue="{Binding SelectedProviderType}" SelectedValuePath="Content" Margin="0,0,0,15" Padding="10" Background="#252525" Foreground="White" BorderThickness="0">
                        <ComboBoxItem Content="OpenAI"/>
                        <ComboBoxItem Content="Groq"/>
                    </ComboBox>

                    <TextBlock Text="API Key" Foreground="#888" Margin="0,0,0,5"/>
                    <TextBox Text="{Binding ApiKey, UpdateSourceTrigger=PropertyChanged}" Margin="0,0,0,15"/>

                    <TextBlock Text="Base URL" Foreground="#888" Margin="0,0,0,5"/>
                    <TextBox Text="{Binding BaseUrl, UpdateSourceTrigger=PropertyChanged}" Margin="0,0,0,20"/>

                    <Button Command="{Binding ConnectCommand}" 
                            HorizontalAlignment="Left" Background="#007AFF" FontWeight="Bold">
                        <Button.Style>
                            <Style TargetType="Button" BasedOn="{StaticResource {x:Type Button}}">
                                <Setter Property="Content" Value="Connect"/>
                                <Setter Property="IsEnabled" Value="True"/>
                                <Style.Triggers>
                                    <DataTrigger Binding="{Binding IsConnecting}" Value="True">
                                        <Setter Property="Content" Value="Connecting..."/>
                                        <Setter Property="IsEnabled" Value="False"/>
                                    </DataTrigger>
                                </Style.Triggers>
                            </Style>
                        </Button.Style>
                    </Button>
                    
                    <TextBlock Text="{Binding ConnectionStatus}" Margin="15,0,0,0" VerticalAlignment="Center" Foreground="#AAA" 
                               Visibility="{Binding ConnectionStatus, Converter={StaticResource BoolToVis}}"/>
                </StackPanel>

                <!-- Step 2: Models & Test -->
                <StackPanel Grid.Row="1" Visibility="{Binding CurrentStep, Converter={StaticResource IntToVisibilityConverter}, ConverterParameter=2}">
                    <TextBlock Text="2. Select &amp; Test Models" FontSize="20" FontWeight="SemiBold" Foreground="#007AFF" Margin="0,0,0,20"/>
                    
                    <TextBlock Text="Transcription Model (Speech to Text)" Foreground="#888" Margin="0,0,0,5"/>
                    <ComboBox ItemsSource="{Binding AvailableTranscriptionModels}" SelectedItem="{Binding SelectedTranscriptionModel}" Margin="0,0,0,20" Padding="10" Background="#252525" Foreground="White"/>

                    <TextBlock Text="Refinement Model (Formatting &amp; Polishing)" Foreground="#888" Margin="0,0,0,5"/>
                    <ComboBox ItemsSource="{Binding AvailableRefinementModels}" SelectedItem="{Binding SelectedRefinementModel}" Margin="0,0,0,20" Padding="10" Background="#252525" Foreground="White"/>

                    <!-- Test Section -->
                    <Border Background="#252525" CornerRadius="8" Padding="20" Margin="0,10,0,0">
                        <StackPanel>
                            <TextBlock Text="Test Configuration" FontWeight="Bold" Foreground="White" Margin="0,0,0,15"/>
                            <StackPanel Orientation="Horizontal" Margin="0,0,0,15">
                                 <Button Command="{Binding RecordTestCommand}" 
                                         Foreground="White" Padding="20,10" BorderThickness="0" FontWeight="Bold">
                                    <Button.Style>
                                        <Style TargetType="Button" BasedOn="{StaticResource {x:Type Button}}">
                                            <Style.Triggers>
                                                <DataTrigger Binding="{Binding IsRecordingTest}" Value="True">
                                                    <Setter Property="Content" Value="Stop Recording"/>
                                                    <Setter Property="Background" Value="#FF453A"/>
                                                </DataTrigger>
                                                <DataTrigger Binding="{Binding IsRecordingTest}" Value="False">
                                                    <Setter Property="Content" Value="Record Test Audio"/>
                                                    <Setter Property="Background" Value="#34C759"/>
                                                </DataTrigger>
                                            </Style.Triggers>
                                        </Style>
                                    </Button.Style>
                                </Button>
                                <TextBlock Text="{Binding TestRecordingStatus}" Foreground="#DDD" VerticalAlignment="Center" Margin="15,0,0,0"/>
                            </StackPanel>

                            <Grid Visibility="{Binding HasTestResults, Converter={StaticResource BoolToVis}}">
                                <Grid.ColumnDefinitions>
                                    <ColumnDefinition Width="*"/>
                                    <ColumnDefinition Width="*"/>
                                    <ColumnDefinition Width="*"/>
                                </Grid.ColumnDefinitions>
                                
                                <!-- Raw -->
                                <Border Grid.Column="0" Background="#222" Margin="0,0,5,0" Padding="10" CornerRadius="4">
                                    <StackPanel>
                                        <DockPanel LastChildFill="False" Margin="0,0,0,5">
                                            <TextBlock Text="Raw (Whisper)" FontWeight="Bold" Foreground="#888" DockPanel.Dock="Left"/>
                                            <TextBlock Text="{Binding TranscriptionTime}" Foreground="#666" FontSize="11" DockPanel.Dock="Right"/>
                                        </DockPanel>
                                        <TextBlock Text="{Binding RawTestTranscription}" TextWrapping="Wrap" Foreground="#AAA" FontSize="11"/>
                                    </StackPanel>
                                </Border>

                                <!-- Default -->
                                <Border Grid.Column="1" Background="#111" Margin="5,0,5,0" Padding="10" CornerRadius="4">
                                    <StackPanel>
                                        <DockPanel LastChildFill="False" Margin="0,0,0,5">
                                            <TextBlock Text="Default Preset" FontWeight="Bold" Foreground="#007AFF" DockPanel.Dock="Left"/>
                                            <TextBlock Text="{Binding DefaultRefinementTime}" Foreground="#005699" FontSize="11" DockPanel.Dock="Right"/>
                                        </DockPanel>
                                        <TextBlock Text="{Binding DefaultTestRefinement}" TextWrapping="Wrap" Foreground="White" FontSize="11"/>
                                    </StackPanel>
                                </Border>

                                <!-- Chat -->
                                <Border Grid.Column="2" Background="#111" Margin="5,0,0,0" Padding="10" CornerRadius="4">
                                    <StackPanel>
                                        <DockPanel LastChildFill="False" Margin="0,0,0,5">
                                            <TextBlock Text="Chat Mode" FontWeight="Bold" Foreground="#34C759" DockPanel.Dock="Left"/>
                                            <TextBlock Text="{Binding ChatRefinementTime}" Foreground="#246939" FontSize="11" DockPanel.Dock="Right"/>
                                        </DockPanel>
                                        <TextBlock Text="{Binding ChatTestRefinement}" TextWrapping="Wrap" Foreground="White" FontStyle="Italic" FontSize="11"/>
                                    </StackPanel>
                                </Border>
                            </Grid>
                        </StackPanel>
                    </Border>
                </StackPanel>

                <!-- Step 3: Hotkey -->
                <StackPanel Grid.Row="1" Visibility="{Binding CurrentStep, Converter={StaticResource IntToVisibilityConverter}, ConverterParameter=3}">
                    <TextBlock Text="3. Set Hotkey" FontSize="20" FontWeight="SemiBold" Foreground="#007AFF" Margin="0,0,0,20"/>
                    
                    <TextBlock Text="Press a key to set it as your dictation hotkey." Foreground="#CCC" Margin="0,0,0,20"/>
                    
                    <Button Command="{Binding StartHotkeyCaptureCommand}" Content="{Binding HotkeyDisplay}" 
                            FontSize="18" FontWeight="Bold" Padding="30,15" Background="#333" Foreground="White" BorderThickness="0" HorizontalAlignment="Left"/>
                            
                    <TextBlock Text="Behavior: Hold to Dictate (Push-to-Talk)" Foreground="#888" Margin="0,20,0,0"/>
                </StackPanel>



            </Grid>
            </ScrollViewer>
        </Border>

        <!-- Footer -->
        <Border Grid.Row="2" Background="#202020" Padding="30,20">
            <Grid>
                <Grid.ColumnDefinitions>
                     <ColumnDefinition Width="Auto"/>
                     <ColumnDefinition Width="*"/>
                     <ColumnDefinition Width="Auto"/>
                </Grid.ColumnDefinitions>
                
                <Button Grid.Column="0" Command="{Binding PrevStepCommand}" Content="Back" 
                        Visibility="{Binding CurrentStep, Converter={StaticResource IntToVisibilityConverter}, ConverterParameter=1Inv}"
                        Background="Transparent" Foreground="#AAA" BorderThickness="0" FontSize="16" Cursor="Hand"/>

                <Button Grid.Column="2" Command="{Binding NextStepCommand}" Content="Next" 
                        Visibility="{Binding CurrentStep, Converter={StaticResource IntToVisibilityConverter}, ConverterParameter=3Inv}"
                        IsEnabled="{Binding IsProviderValid}"
                        Background="#007AFF" Foreground="White" Padding="30,10" BorderThickness="0" FontWeight="Bold" Cursor="Hand">
                        <Button.Resources>
                            <Style TargetType="Border">
                                <Setter Property="CornerRadius" Value="4"/>
                            </Style>
                        </Button.Resources>
                </Button>

                <Button Grid.Column="2" Command="{Binding CompleteSetupCommand}" Content="Finish &amp; Start Working" 
                        Visibility="{Binding CurrentStep, Converter={StaticResource IntToVisibilityConverter}, ConverterParameter=3}"
                        Background="#34C759" Foreground="White" Padding="30,10" BorderThickness="0" FontWeight="Bold" Cursor="Hand">
                        <Button.Resources>
                            <Style TargetType="Border">
                                <Setter Property="CornerRadius" Value="4"/>
                            </Style>
                        </Button.Resources>
                </Button>
            </Grid>
        </Border>
    </Grid>
</Window>
